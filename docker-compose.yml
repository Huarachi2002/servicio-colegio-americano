version: '3.8'

services:
  # ==================== APLICACIÓN NESTJS ====================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: dms2_app
    restart: unless-stopped
    ports:
      - "${PORT:-8080}:8080"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 8080
      
      # Migraciones automáticas (true para primera ejecución)
      RUN_MIGRATIONS: ${RUN_MIGRATIONS:-true}
      
      # SQL Server - Base de datos principal de la aplicación (dms_sccs)
      DB_HOST: ${DB_HOST:-host.docker.internal}
      DB_PORT: ${DB_PORT:-1433}
      DB_DATABASE: ${DB_DATABASE:-dms_sccs}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_ENCRYPT: ${DB_ENCRYPT:-true}
      DB_TRUST_SERVER_CERTIFICATE: ${DB_TRUST_SERVER_CERTIFICATE:-true}
      
      # SQL Server SAP (base de datos existente de SAP)
      SAP_DB_HOST: ${SAP_DB_HOST:-host.docker.internal}
      SAP_DB_PORT: ${SAP_DB_PORT:-1433}
      SAP_DB_USERNAME: ${SAP_DB_USERNAME}
      SAP_DB_PASSWORD: ${SAP_DB_PASSWORD}
      SAP_DB_DATABASE: ${SAP_DB_DATABASE:-SCCS_QAS}
      SAP_DB_ENCRYPT: ${SAP_DB_ENCRYPT:-true}
      SAP_DB_TRUST_SERVER_CERTIFICATE: ${SAP_DB_TRUST_SERVER_CERTIFICATE:-true}
      
      # JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-7d}
      
      # Versiones APP
      APK_VERSION: ${APK_VERSION}
      IPA_VERSION: ${IPA_VERSION}

      # SAP Service Layer
      SAP_SERVICE_LAYER_URL: ${SAP_SERVICE_LAYER_URL}
      SAP_COMPANY_DB: ${SAP_COMPANY_DB}
      SAP_SL_USER: ${SAP_SL_USER}
      SAP_SL_PASSWORD: ${SAP_SL_PASSWORD}

      # BNB Service
      BNB_API_URL: ${BNB_API_URL} 
      BNB_ACCOUNT_ID: ${BNB_ACCOUNT_ID}
      BNB_AUTH_ID: ${BNB_AUTH_ID}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # Límites de recursos
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    # Logging con rotación
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
